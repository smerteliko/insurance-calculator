name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3.6.0

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@2.28.0
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, json, zip
          tools: composer

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Basic validation
        run: |
          php -v
          composer --version
          echo "âœ… Environment setup completed"

  deploy:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-20.04
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v3.6.0

      - name: Setup PHP
        uses: shivammathur/setup-php@2.28.0
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, json, zip

      - name: Build production
        run: |
          composer install --no-dev --optimize-autoloader
          echo "APP_ENV=prod" > .env
          echo "APP_DEBUG=0" >> .env

      - name: Create package
        run: |
          zip -r build.zip . -x "*.git*" "node_modules/*" "tests/*" "var/*"

      - name: Upload artifact
        uses: actions/upload-artifact@v3.1.3
        with:
          name: app-build
          path: build.zip