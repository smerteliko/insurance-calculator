name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, intl, json, zip
          coverage: none

      - name: Remove composer.lock if incompatible
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≤–µ—Ä—Å–∏–π –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–¥–∞–ª—è–µ–º lock file
          if [ -f composer.lock ]; then
            if ! composer validate --strict --no-check-lock; then
              echo "Removing incompatible composer.lock"
              rm composer.lock
            fi
          fi

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Create .env file
        run: |
          if [ -f .env.test ]; then
            cp .env.test .env
          else
            cp .env.dist .env
          fi
          echo "APP_SECRET=$(openssl rand -hex 32)" >> .env

      - name: Run tests
        run: |
          if [ -f "vendor/bin/phpunit" ]; then
            ./vendor/bin/phpunit --testdox
          else
            echo "PHPUnit not found, skipping tests"
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, intl, json, zip

      - name: Remove composer.lock if incompatible
        run: |
          if [ -f composer.lock ]; then
            if ! composer validate --strict --no-check-lock; then
              echo "Removing incompatible composer.lock"
              rm composer.lock
            fi
          fi

      - name: Install production dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader --no-dev

      - name: Setup production environment
        run: |
          cp .env.dist .env
          echo "APP_ENV=prod" >> .env
          echo "APP_DEBUG=0" >> .env
          echo "APP_SECRET=$(openssl rand -hex 32)" >> .env

      - name: Clear cache
        run: |
          if [ -f "bin/console" ]; then
            php bin/console cache:clear --env=prod --no-debug
          else
            echo "bin/console not found, skipping cache clear"
          fi

      - name: Create deployment package
        run: |
          mkdir -p deployment
          # –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã
          cp -r bin config public src templates translations vendor .env composer.json composer.lock symfony.lock deployment/
          # –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          mkdir -p deployment/var/log
          mkdir -p deployment/var/cache
          chmod -R 755 deployment/var
          cd deployment && zip -r ../insurance-calculator.zip .

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: insurance-calculator
          path: insurance-calculator.zip

      - name: Show deployment info
        run: |
          echo "üöÄ Application is ready for deployment!"
          echo "üì¶ Download the artifact: insurance-calculator.zip"
          echo "üåê You can deploy this to any PHP hosting"
          echo "üêò PHP 8.2 + Symfony 7.0"